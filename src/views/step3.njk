{% extends "layouts/main.njk" %}

{% block content %}
<div class="progress-bar">
  <div class="progress-step">1. Applicant Info</div>
  <div class="progress-step">2. Medical</div>
  <div class="progress-step active">3. Income</div>
  <div class="progress-step">4. Residency</div>
  <div class="progress-step">5. Request</div>
  <div class="progress-step">6. Certification</div>
</div>


{% if isDevelopment %}
<div style="margin: 20px 0 10px 0;">
  <button type="button" id="populate-form-btn" style="background:#28a745; color:white; border:none; padding:10px 18px; border-radius:4px; font-size:15px;">Populate Form (Dev Only)</button>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('populate-form-btn');
    if (btn) {
      btn.addEventListener('click', function() {
        const data = {
          'income[appliedDisability]': 'true',
          'income[receives][type]': 'SSDI',
          'income[receives][monthlyAmount]': '1200',
          'income[currentlyEmployed]': 'true',
          'income[unemployment][receiving]': 'false',
          'income[unemployment][amount]': '',
          'employmentApplicant[employerName]': 'Acme Corp',
          'employmentApplicant[status]': 'Full-Time, Part-Time',
          'employmentApplicant[grossIncome]': '2000',
          'spouse[name]': 'Jane Public',
          'spouse[employerName]': 'Widgets Inc',
          'spouse[status]': 'Full-Time, Part-Time',
          'spouse[grossTaxableIncome]': '18000',
        };
        for (const [name, value] of Object.entries(data)) {
          const radios = document.querySelectorAll(`input[type="radio"][name="${name}"]`);
          if (radios.length > 0) {
            radios.forEach(r => { r.checked = (r.value === value); });
            continue;
          }
          const el = document.querySelector(`[name="${name}"]`);
          if (el) {
            if (el.type === 'checkbox') {
              el.checked = !!value;
            } else {
              el.value = value;
            }
          }
        }
      });
    }
  });
</script>
{% endif %}

<h2>Step 3: Income & Employment</h2>

<form method="POST" action="/applications/{{ application.id }}/step/3" 
      hx-trigger="change delay:500ms" 
      hx-post="/applications/{{ application.id }}/autosave"
      hx-target="#autosave-indicator"
      hx-swap="innerHTML">
  
  <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  
  <div id="autosave-indicator"></div>

  <fieldset>
    <legend>Income Information</legend>
    
    <div class="form-group">
      <label class="required">Have you applied for disability?</label>
      <div class="segmented-control" id="appliedDisabilityControl">
        <label><input type="radio" id="income.appliedDisability-yes" name="income[appliedDisability]" value="true" {% if application.data.income.appliedDisability %}checked{% endif %} required> Yes</label>
        <label><input type="radio" id="income.appliedDisability-no" name="income[appliedDisability]" value="false" {% if not application.data.income.appliedDisability %}checked{% endif %} required> No</label>
      </div>
    </div>

    <div class="form-group">
      <label class="required">Receive Disability Benefits?</label>
      <div class="segmented-control" id="disabilityBenefitsControl">
        <label><input type="radio" id="income.receives-ssdi" name="income[receives][type]" value="SSDI" {% if application.data.income.receives.type == 'SSDI' %}checked{% endif %}> SSDI</label>
        <label><input type="radio" id="income.receives-ssi" name="income[receives][type]" value="SSI" {% if application.data.income.receives.type == 'SSI' %}checked{% endif %}> SSI</label>
        <label><input type="radio" id="income.receives-none" name="income[receives][type]" value="None" {% if not application.data.income.receives.type or application.data.income.receives.type == 'None' %}checked{% endif %}> None</label>
      </div>
    </div>

    <div class="form-group">
      <label for="income.receives.monthlyAmount">Monthly Amount (if receiving SSDI/SSI)</label>
      <div class="currency-input-wrapper">
        <span class="currency-symbol">$</span>
        <input type="number" id="income.receives.monthlyAmount" name="income[receives][monthlyAmount]" 
               min="0" step="0.01" value="{{ application.data.income.receives.monthlyAmount or '' }}">
      </div>
      {% if errors['income.receives.monthlyAmount'] %}
        <div class="error">{{ errors['income.receives.monthlyAmount'] }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label class="required">Currently Employed</label>
      <div class="segmented-control" id="currentlyEmployedControl">
        <label><input type="radio" id="income.currentlyEmployed-yes" name="income[currentlyEmployed]" value="true" {% if application.data.income.currentlyEmployed %}checked{% endif %} required> Yes</label>
        <label><input type="radio" id="income.currentlyEmployed-no" name="income[currentlyEmployed]" value="false" {% if not application.data.income.currentlyEmployed %}checked{% endif %} required> No</label>
      </div>
    </div>

    <div class="form-group">
      <label class="required">Receiving Unemployment Benefits</label>
      <div class="segmented-control" id="unemploymentReceivingControl">
        <label><input type="radio" id="income.unemployment.receiving-yes" name="income[unemployment][receiving]" value="true" {% if application.data.income.unemployment.receiving %}checked{% endif %} required> Yes</label>
        <label><input type="radio" id="income.unemployment.receiving-no" name="income[unemployment][receiving]" value="false" {% if not application.data.income.unemployment.receiving %}checked{% endif %} required> No</label>
      </div>
    </div>

    <div class="form-group">
      <label for="income.unemployment.amount">Unemployment Amount (if receiving)</label>
      <div class="currency-input-wrapper">
        <span class="currency-symbol">$</span>
        <input type="number" id="income.unemployment.amount" name="income[unemployment][amount]" 
               min="0" step="0.01" value="{{ application.data.income.unemployment.amount or '' }}">
      </div>
      {% if errors['income.unemployment.amount'] %}
        <div class="error">{{ errors['income.unemployment.amount'] }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="income.otherIncome">Other Income Sources</label>
      <textarea id="income.otherIncome" name="income[otherIncome]" rows="3">{{ application.data.income.otherIncome or '' }}</textarea>
    </div>
  </fieldset>

  <fieldset>
    <legend>Applicant Employment</legend>
    
    <div class="form-group">
      <label for="employmentApplicant.employerName">Employer Name</label>
      <input type="text" id="employmentApplicant.employerName" name="employmentApplicant[employerName]" 
             value="{{ application.data.employmentApplicant.employerName or '' }}">
    </div>

    <div class="form-group">
      <label class="required">Employment Status</label>
      <div class="segmented-control" id="employmentStatusControl">
        <label><input type="radio" id="employmentApplicant.status-full-part" name="employmentApplicant[status]" value="Full-Time, Part-Time" {% if application.data.employmentApplicant.status == 'Full-Time, Part-Time' %}checked{% endif %} required> Full-Time, Part-Time</label>
        <label><input type="radio" id="employmentApplicant.status-self" name="employmentApplicant[status]" value="Self-Employed" {% if application.data.employmentApplicant.status == 'Self-Employed' %}checked{% endif %} required> Self-Employed</label>
        <label><input type="radio" id="employmentApplicant.status-unemployed" name="employmentApplicant[status]" value="Unemployed" {% if application.data.employmentApplicant.status == 'Unemployed' %}checked{% endif %} required> Unemployed</label>
      </div>
    </div>

    <div class="form-group">
      <label for="employmentApplicant.otherStatusText">Other Status (if applicable)</label>
      <input type="text" id="employmentApplicant.otherStatusText" name="employmentApplicant[otherStatusText]" 
             value="{{ application.data.employmentApplicant.otherStatusText or '' }}">
    </div>

    <div class="form-group">
      <label for="employmentApplicant.grossIncome">Gross Income</label>
      <div class="currency-input-wrapper">
        <span class="currency-symbol">$</span>
        <input type="number" id="employmentApplicant.grossIncome" name="employmentApplicant[grossIncome]" 
               min="0" step="0.01" value="{{ application.data.employmentApplicant.grossIncome or '' }}">
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Spouse Information (if applicable)</legend>
    
    <div class="form-group">
      <label for="spouse.name">Spouse Name</label>
      <input type="text" id="spouse.name" name="spouse[name]" 
             value="{{ application.data.spouse.name or '' }}">
    </div>

    <div class="form-group">
      <label for="spouse.phone">Spouse Phone</label>
      <input type="tel" id="spouse.phone" name="spouse[phone]" 
             value="{{ application.data.spouse.phone | phone }}" 
             placeholder="(999) 999-9999" 
             pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
             class="phone-input">
    </div>

    <div class="form-group">
      <label for="spouse.employerName">Spouse Employer Name</label>
      <input type="text" id="spouse.employerName" name="spouse[employerName]" 
             value="{{ application.data.spouse.employerName or '' }}">
    </div>

    <div class="form-group">
      <label class="required">Spouse Employment Status</label>
      <div class="segmented-control" id="spouseStatusControl">
        <label><input type="radio" id="spouse.status-full-part" name="spouse[status]" value="Full-Time, Part-Time" {% if application.data.spouse.status == 'Full-Time, Part-Time' %}checked{% endif %} required> Full-Time, Part-Time</label>
        <label><input type="radio" id="spouse.status-self" name="spouse[status]" value="Self-Employed" {% if application.data.spouse.status == 'Self-Employed' %}checked{% endif %} required> Self-Employed</label>
        <label><input type="radio" id="spouse.status-unemployed" name="spouse[status]" value="Unemployed" {% if application.data.spouse.status == 'Unemployed' %}checked{% endif %} required> Unemployed</label>
      </div>
    </div>

    <div class="form-group">
      <label for="spouse.otherStatusText">Other Status (if applicable)</label>
      <input type="text" id="spouse.otherStatusText" name="spouse[otherStatusText]" 
             value="{{ application.data.spouse.otherStatusText or '' }}">
    </div>

    <div class="form-group">
      <label for="spouse.grossTaxableIncome">Spouse Gross Taxable Income</label>
      <div class="currency-input-wrapper">
        <span class="currency-symbol">$</span>
        <input type="number" id="spouse.grossTaxableIncome" name="spouse[grossTaxableIncome]" 
               min="0" step="0.01" value="{{ application.data.spouse.grossTaxableIncome or '' }}">
      </div>
    </div>
  </fieldset>

  <div class="form-navigation">
    <a href="/applications/{{ application.id }}/step/2" class="btn-secondary">Back to Step 2</a>
    <button type="submit">Continue to Step 4</button>
  </div>
</form>

<style>
  .segmented-control {
    display: flex;
    gap: 10px;
    margin: 5px 0 0 0;
  }
  .segmented-control label {
    background: #f4f4f4;
    border: 1px solid #bbb;
    border-radius: 4px;
    padding: 5px 14px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s, border 0.2s;
  }
  .segmented-control input[type="radio"] {
    display: none;
  }
  .segmented-control input[type="radio"]:checked + span,
  .segmented-control label:has(input[type="radio"]:checked) {
    background: #490075;
    color: #fff;
    border-color: #490075;
  }
</style>
{% endblock %}
