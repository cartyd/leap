{% extends "layouts/main.njk" %}

{% block content %}
<div class="progress-bar">
  <div class="progress-step">1. Applicant Info</div>
  <div class="progress-step">2. Medical</div>
  <div class="progress-step">3. Income</div>
  <div class="progress-step">4. Residency</div>
  <div class="progress-step active">5. Request</div>
  <div class="progress-step">6. Certification</div>
</div>


{% if isDevelopment %}
<div style="margin: 20px 0 10px 0;">
  <button type="button" id="populate-form-btn" style="background:#28a745; color:white; border:none; padding:10px 18px; border-radius:4px; font-size:15px;">Populate Form (Dev Only)</button>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('populate-form-btn');
    if (btn) {
      btn.addEventListener('click', function() {
        const data = {
          'natureOfRequest': 'Need help with medication costs',
          'vendors[0][vendorName]': 'Pharmacy One',
          'vendors[0][contactPerson]': 'Alice',
          'vendors[0][telephone]': '(404) 555-1111',
          'vendors[0][address]': '789 Health St',
          'vendors[0][city]': 'Atlanta',
          'vendors[0][state]': 'GA',
          'vendors[0][zip]': '30301',
          'vendors[0][totalAmountOwed]': '200',
          'vendors[0][amountRequesting]': '150',
          'vendors[1][vendorName]': 'Medical Supply Co',
          'vendors[1][contactPerson]': 'Bob',
          'vendors[1][telephone]': '(404) 555-2222',
          'vendors[1][address]': '123 Med Ave',
          'vendors[1][city]': 'Atlanta',
          'vendors[1][state]': 'GA',
          'vendors[1][zip]': '30302',
          'vendors[1][totalAmountOwed]': '300',
          'vendors[1][amountRequesting]': '250',
        };
        for (const [name, value] of Object.entries(data)) {
          const el = document.querySelector(`[name="${name}"]`);
          if (el) el.value = value;
        }
      });
    }
  });
</script>
{% endif %}

<h2>Step 5: Request Details & Vendors</h2>

<form method="POST" action="/applications/{{ application.id }}/step/5" 
      hx-trigger="change delay:500ms" 
      hx-post="/applications/{{ application.id }}/autosave"
      hx-target="#autosave-indicator"
      hx-swap="innerHTML">
  
  <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  
  <div id="autosave-indicator"></div>


  <fieldset>
    <legend>Nature of Request</legend>
    <div class="form-group">
      <label for="natureOfRequest" class="required">Describe the nature of your request</label>
      <textarea id="natureOfRequest" name="natureOfRequest" rows="5" required>{{ application.data.natureOfRequest or '' }}</textarea>
      {% if errors['natureOfRequest'] %}
        <div class="error">{{ errors['natureOfRequest'] }}</div>
      {% endif %}
      <small>Please provide a detailed explanation of what assistance you are requesting and why.</small>
    </div>
  </fieldset>

  <fieldset>
    <legend>Vendor Information</legend>
    <p>Please provide information for up to 3 vendors. At least one vendor is required.</p>
    
    {% for i in range(3) %}
    <div class="vendor-group">
      <h3>Vendor {{ i + 1 }}{% if i == 0 %} <span class="required">(Required)</span>{% endif %}</h3>
      
      <div class="form-group">
        <label for="vendors[{{ i }}].vendorName"{% if i == 0 %} class="required"{% endif %}>Vendor Name</label>
        <input type="text" id="vendors[{{ i }}].vendorName" name="vendors[{{ i }}][vendorName]" 
               value="{{ application.data.vendors[i].vendorName or '' if application.data.vendors[i] else '' }}"
               {% if i == 0 %}required{% endif %}>
        {% if errors['vendors.' + i|string + '.vendorName'] %}
          <div class="error">{{ errors['vendors.' + i|string + '.vendorName'] }}</div>
        {% endif %}
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendors[{{ i }}].contactPerson">Contact Person</label>
          <input type="text" id="vendors[{{ i }}].contactPerson" name="vendors[{{ i }}][contactPerson]" 
                 value="{{ application.data.vendors[i].contactPerson or '' if application.data.vendors[i] else '' }}">
        </div>
        
        <div class="form-group">
          <label for="vendors[{{ i }}].telephone">Telephone</label>
          <input type="tel" id="vendors[{{ i }}].telephone" name="vendors[{{ i }}][telephone]" 
                 value="{{ application.data.vendors[i].telephone | phone if application.data.vendors[i] else '' }}" 
                 placeholder="(999) 999-9999" 
                 pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
                 class="phone-input">
        </div>
      </div>

      <div class="form-group">
        <label for="vendors[{{ i }}].address">Address</label>
        <input type="text" id="vendors[{{ i }}].address" name="vendors[{{ i }}][address]" 
               value="{{ application.data.vendors[i].address or '' if application.data.vendors[i] else '' }}">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendors[{{ i }}].city">City</label>
          <input type="text" id="vendors[{{ i }}].city" name="vendors[{{ i }}][city]" 
                 value="{{ application.data.vendors[i].city or '' if application.data.vendors[i] else '' }}">
        </div>
        
        <div class="form-group">
          <label for="vendors[{{ i }}].state">State</label>
          <input type="text" id="vendors[{{ i }}].state" name="vendors[{{ i }}][state]" 
                 maxlength="2" value="{{ application.data.vendors[i].state or '' if application.data.vendors[i] else '' }}">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendors[{{ i }}].zip">ZIP Code</label>
          <input type="text" id="vendors[{{ i }}].zip" name="vendors[{{ i }}][zip]" 
                 value="{{ application.data.vendors[i].zip or '' if application.data.vendors[i] else '' }}">
        </div>
        
        <div class="form-group">
          <label for="vendors[{{ i }}].fax">Fax</label>
          <input type="tel" id="vendors[{{ i }}].fax" name="vendors[{{ i }}][fax]" 
                 value="{{ application.data.vendors[i].fax | phone if application.data.vendors[i] else '' }}" 
                 placeholder="(999) 999-9999" 
                 pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
                 class="phone-input">
        </div>
      </div>

      <div class="form-group">
        <label for="vendors[{{ i }}].email">Email</label>
        <input type="email" id="vendors[{{ i }}].email" name="vendors[{{ i }}][email]" 
               value="{{ application.data.vendors[i].email or '' if application.data.vendors[i] else '' }}" 
               placeholder="example@email.com" 
               pattern="[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,}$" 
               title="Please enter a valid email address">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendors[{{ i }}].totalAmountOwed" class="vendor-amount-label">Total Amount Owed</label>
          <div style="position:relative;">
            <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#666; font-size:15px;">$</span>
            <input type="number" id="vendors[{{ i }}].totalAmountOwed" name="vendors[{{ i }}][totalAmountOwed]" 
                   min="0" step="0.01" value="{{ application.data.vendors[i].totalAmountOwed or '' if application.data.vendors[i] else '' }}" style="padding-left:22px;">
          </div>
        </div>
        <div class="form-group">
          <label for="vendors[{{ i }}].amountRequesting" class="vendor-amount-label">Amount Requesting</label>
          <div style="position:relative;">
            <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#666; font-size:15px;">$</span>
            <input type="number" id="vendors[{{ i }}].amountRequesting" name="vendors[{{ i }}][amountRequesting]" 
                   min="0" step="0.01" value="{{ application.data.vendors[i].amountRequesting or '' if application.data.vendors[i] else '' }}" style="padding-left:22px;">
          </div>
          {% if errors['vendors.' + i|string + '.amountRequesting'] %}
            <div class="error">{{ errors['vendors.' + i|string + '.amountRequesting'] }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </fieldset>

  <div class="form-navigation">
    <a href="/applications/{{ application.id }}/step/4" class="btn-secondary">Back to Step 4</a>
    <button type="submit" id="step5-continue-btn">Continue to Step 6</button>
  </div>

<script>
document.getElementById('step5-continue-btn').addEventListener('click', function(e) {
  // SSDI/SSI checkbox validation
  var ssdiSsiCheckbox = document.getElementById('receives-ssdi-ssi');
  if (ssdiSsiCheckbox && ssdiSsiCheckbox.checked) {
    // If checked, require at least one vendor with a name
    var vendorValid = false;
    for (var i = 0; i < 3; i++) {
      var vendorName = document.getElementById('vendors['+i+'].vendorName');
      if (vendorName && vendorName.value.trim() !== '') {
        vendorValid = true;
        break;
      }
    }
    if (!vendorValid) {
      alert('If you receive SSDI or SSI, you must specify at least one vendor.');
      e.preventDefault();
      return;
    }
  }
  // For each vendor, if vendor name is specified, require Total Amount Owed and Amount Requesting
  for (var i = 0; i < 3; i++) {
    var vendorName = document.getElementById('vendors['+i+'].vendorName');
    var totalAmountOwed = document.getElementById('vendors['+i+'].totalAmountOwed');
    var amountRequesting = document.getElementById('vendors['+i+'].amountRequesting');
    if (vendorName && vendorName.value.trim() !== '') {
      if (!totalAmountOwed.value || parseFloat(totalAmountOwed.value) <= 0) {
        alert('Total Amount Owed is required and must be greater than 0 for vendor #' + (i+1));
        e.preventDefault();
        return;
      }
      if (!amountRequesting.value || parseFloat(amountRequesting.value) <= 0) {
        alert('Amount Requesting is required and must be greater than 0 for vendor #' + (i+1));
        e.preventDefault();
        return;
      }
      if (parseFloat(amountRequesting.value) > parseFloat(totalAmountOwed.value)) {
        alert('Amount Requesting cannot be greater than Total Amount Owed for vendor #' + (i+1));
        e.preventDefault();
        return;
      }
    }
  }
});
</script>
</form>
{% endblock %}
