{% extends "layouts/main.njk" %}

{% block content %}

<div class="progress-bar">
  <div class="progress-step active">1. Applicant Info</div>
  <div class="progress-step">2. Medical</div>
  <div class="progress-step">3. Income</div>
  <div class="progress-step">4. Residency</div>
  <div class="progress-step">5. Request</div>
  <div class="progress-step">6. Certification</div>
</div>

{% if isDevelopment %}
<div style="margin: 20px 0 10px 0;">
  <button type="button" id="populate-form-btn" style="background:#28a745; color:white; border:none; padding:10px 18px; border-radius:4px; font-size:15px;">Populate Form (Dev Only)</button>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('populate-form-btn');
    if (btn) {
      btn.addEventListener('click', function() {
        const data = {
          'guardianName': 'Jane Doe',
          'applicant[firstName]': 'John',
          'applicant[middleInitial]': 'Q',
          'applicant[lastName]': 'Public',
          'applicant[email]': 'john.public@example.com',
          'applicant[dob]': '1990-01-01',
          'applicant[address1]': '123 Main St',
          'applicant[city]': 'Atlanta',
          'applicant[state]': 'GA',
          'applicant[zip]': '30301',
          'applicant[county]': 'Fulton',
          'request[assistanceFor]': 'Prescription Medication',
          'request[approximateCost]': '145',
          // Add more fields as needed
        };
        for (const [name, value] of Object.entries(data)) {
          const el = document.querySelector(`[name="${name}"]`);
          if (el) el.value = value;
        }
      });
    }
  });
</script>
{% endif %}


<h2>Step 1: Applicant & Guardian Information</h2>

<form method="POST" action="/applications/{{ application.id }}/step/1" 
  hx-trigger="change delay:500ms" 
  hx-post="/applications/{{ application.id }}/autosave"
  hx-target="#autosave-indicator"
  hx-swap="innerHTML" class="compact-form">
  <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  <div id="autosave-indicator"></div>

  <details style="margin-bottom:10px;">
    <summary style="font-weight:600; font-size:15px; color:#490075; cursor:pointer;">Guardian Information (if applicable)</summary>
    <div class="form-row" style="margin-top:10px;">
      <div class="form-group" style="margin-bottom:0;">
        <label for="guardianName" style="display:inline-block; min-width:110px; margin-right:8px;">Guardian Name</label>
        <input type="text" id="guardianName" name="guardianName" 
               value="{{ application.data.guardianName or '' }}" style="width:70%; display:inline-block;">
      </div>
    </div>
  </details>

  <fieldset>
    <legend>Applicant Information</legend>
    <div class="form-row" style="grid-template-columns: 1fr 1fr 60px; gap:10px;">
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.firstName" class="required" style="margin-bottom:2px;">First Name</label>
        <input type="text" id="applicant.firstName" name="applicant[firstName]" 
               value="{{ application.data.applicant.firstName or '' }}" required>
        {% if errors['applicant.firstName'] %}
          <div class="error">{{ errors['applicant.firstName'] }}</div>
        {% endif %}
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.lastName" class="required" style="margin-bottom:2px;">Last Name</label>
        <input type="text" id="applicant.lastName" name="applicant[lastName]" 
               value="{{ application.data.applicant.lastName or '' }}" required>
        {% if errors['applicant.lastName'] %}
          <div class="error">{{ errors['applicant.lastName'] }}</div>
        {% endif %}
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.middleInitial" style="margin-bottom:2px;">MI</label>
        <input type="text" id="applicant.middleInitial" name="applicant[middleInitial]" maxlength="1" value="{{ application.data.applicant.middleInitial or '' }}">
      </div>
    </div>
    <div class="form-row" style="gap:10px;">
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.email" class="required" style="margin-bottom:2px;">Email</label>
        <input type="email" id="applicant.email" name="applicant[email]" 
               value="{{ application.data.applicant.email or '' }}" 
               placeholder="example@email.com" 
               pattern="[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,}$" 
               title="Please enter a valid email address" 
               required>
        {% if errors['applicant.email'] %}
          <div class="error">{{ errors['applicant.email'] }}</div>
        {% endif %}
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.dob" class="required" style="margin-bottom:2px;">Date of Birth</label>
        <input type="date" id="applicant.dob" name="applicant[dob]" 
               value="{{ application.data.applicant.dob or '' }}" required>
        {% if errors['applicant.dob'] %}
          <div class="error">{{ errors['applicant.dob'] }}</div>
        {% endif %}
      </div>
    </div>
    <div class="form-row" style="gap:10px;">
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.address1" class="required" style="margin-bottom:2px;">Address</label>
        <input type="text" id="applicant.address1" name="applicant[address1]" 
               value="{{ application.data.applicant.address1 or '' }}" required>
        {% if errors['applicant.address1'] %}
          <div class="error">{{ errors['applicant.address1'] }}</div>
        {% endif %}
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.city" class="required" style="margin-bottom:2px;">City</label>
        <input type="text" id="applicant.city" name="applicant[city]" 
               value="{{ application.data.applicant.city or '' }}" required readonly tabindex="-1" class="readonly-field">
        {% if errors['applicant.city'] %}
          <div class="error">{{ errors['applicant.city'] }}</div>
        {% endif %}
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.state" class="required" style="margin-bottom:2px;">State</label>
        <input type="text" id="applicant.state" name="applicant[state]" 
               value="{{ application.data.applicant.state or '' }}" required readonly tabindex="-1" class="readonly-field">
        {% if errors['applicant.state'] %}
          <div class="error">{{ errors['applicant.state'] }}</div>
        {% endif %}
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.county" class="required" style="margin-bottom:2px;">County</label>
        <input type="text" id="applicant.county" name="applicant[county]" 
               value="{{ application.data.applicant.county or '' }}" required readonly tabindex="-1" class="readonly-field">
        {% if errors['applicant.county'] %}
          <div class="error">{{ errors['applicant.county'] }}</div>
        {% endif %}
      </div>
    </div>
    <div class="form-row" style="gap:10px;">
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.zip" class="required" style="margin-bottom:2px;">ZIP Code</label>
        <input type="text" id="applicant.zip" name="applicant[zip]" 
               value="{{ application.data.applicant.zip or '' }}" required>
        {% if errors['applicant.zip'] %}
          <div class="error">{{ errors['applicant.zip'] }}</div>
        {% endif %}
      </div>
    </div>
    <div class="form-row" style="gap:10px;">
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.phoneHome" style="margin-bottom:2px;">Home Phone</label>
        <input type="tel" id="applicant.phoneHome" name="applicant[phoneHome]" 
               value="{{ application.data.applicant.phoneHome | phone }}" 
               placeholder="(999) 999-9999" 
               pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
               class="phone-input">
      </div>
      <div class="form-group" style="margin-bottom:8px;">
        <label for="applicant.phoneCell" style="margin-bottom:2px;">Cell Phone</label>
        <input type="tel" id="applicant.phoneCell" name="applicant[phoneCell]" 
               value="{{ application.data.applicant.phoneCell | phone }}" 
               placeholder="(999) 999-9999" 
               pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
               class="phone-input">
      </div>
    </div>
  </fieldset>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // If zip is present and city/state/county are missing, trigger lookup
      var zipInput = document.getElementById('applicant.zip');
      var cityInput = document.getElementById('applicant.city');
      var stateInput = document.getElementById('applicant.state');
      var countyInput = document.getElementById('applicant.county');
      if (zipInput && cityInput && stateInput && countyInput) {
        var zipVal = zipInput.value;
        var cityVal = cityInput.value;
        var stateVal = stateInput.value;
        var countyVal = countyInput.value;
        if (zipVal && zipVal.length === 5 && (!cityVal || !stateVal || !countyVal)) {
          // Wait for ga-zip-lookup.js to load, then trigger lookup
          setTimeout(function() {
            var event = new Event('input', { bubbles: true });
            zipInput.dispatchEvent(event);
          }, 300);
        }
      }
    });
  </script>

  <fieldset>
    <legend>Request Information</legend>
    
    <div class="form-group">
      <label for="request.assistanceFor" class="required">Requesting Assistance For</label>
      <input type="text" id="request.assistanceFor" name="request[assistanceFor]" 
             value="{{ application.data.request.assistanceFor or '' }}" required>
      {% if errors['request.assistanceFor'] %}
        <div class="error">{{ errors['request.assistanceFor'] }}</div>
      {% endif %}
    </div>

    <div class="form-group">
            <label for="request.approximateCost" class="required">Approximate Cost <span style="font-weight:normal; color:#666;">(USD)</span></label>
            <div style="position:relative;">
         <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#666; font-size:15px;">$</span>
         <input type="number" id="request.approximateCost" name="request[approximateCost]" 
           min="0" step="1" value="{{ application.data.request.approximateCost or '' }}" required style="padding-left:22px;">
            </div>
      {% if errors['request.approximateCost'] %}
        <div class="error">{{ errors['request.approximateCost'] }}</div>
      {% endif %}
    </div>
  </fieldset>

  <div class="form-navigation">
    <div></div>
    <button type="submit">Continue to Step 2</button>
  </div>

  {% if isDevelopment %}
  <script>
    document.getElementById('populate-form-btn').addEventListener('click', function() {
      const data = {
        'guardianName': 'Jane Doe',
        'applicant[firstName]': 'John',
        'applicant[middleInitial]': 'Q',
        'applicant[lastName]': 'Public',
        'applicant[email]': 'john.public@example.com',
        'applicant[dob]': '1990-01-01',
        'applicant[city]': 'Atlanta',
        'applicant[state]': 'GA',
        'applicant[zip]': '30301',
        'applicant[county]': 'Fulton',
        'request[approximateCost]': '1000',
        // Add more fields as needed
      };
      for (const [name, value] of Object.entries(data)) {
        const el = document.querySelector(`[name="${name}"]`);
        if (el) el.value = value;
      }
    });
  </script>
  {% endif %}
</form>
{% endblock %}
