{% extends "layouts/main.njk" %}

{% block content %}
<div class="progress-bar">
  <div class="progress-step">1. Applicant Info</div>
  <div class="progress-step active">2. Medical</div>
  <div class="progress-step">3. Income</div>
  <div class="progress-step">4. Residency</div>
  <div class="progress-step">5. Request</div>
  <div class="progress-step">6. Certification</div>
</div>


{% if isDevelopment %}
<div style="margin: 20px 0 10px 0;">
  <button type="button" id="populate-form-btn" style="background:#28a745; color:white; border:none; padding:10px 18px; border-radius:4px; font-size:15px;">Populate Form (Dev Only)</button>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('populate-form-btn');
    if (btn) {
      btn.addEventListener('click', function() {
        const data = {
          'medicalHistory[diagnosisYear]': '2010',
          'medicalHistory[lupusType]': 'Systemic',
          'medicalHistory[physicianName]': 'Dr. Smith',
          'medicalHistory[physicianPhone]': '(404) 555-1234',
          // radios
          'medicalCoverage[hasInsurance]': 'true',
          'medicalCoverage[coverageType]': 'Private',
          'medicalCoverage[rxCoverage]': 'Yes',
          // dependent fields
          'medicalCoverage[privateInsuranceName]': 'Blue Cross',
          'medicalCoverage[copayAmount]': '25',
        };
        for (const [name, value] of Object.entries(data)) {
          const radios = document.querySelectorAll(`input[type="radio"][name="${name}"]`);
          if (radios.length > 0) {
            radios.forEach(r => { r.checked = (r.value === value); });
            continue;
          }
          const el = document.querySelector(`[name="${name}"]`);
          if (el) {
            if (el.type === 'checkbox') {
              el.checked = value === true || value === 'true';
            } else {
              el.value = value;
            }
          }
        }
        // Refresh conditional UI after programmatic changes
        if (typeof updateCoverageTypeEnabled === 'function') updateCoverageTypeEnabled();
        if (typeof updatePrivateInsuranceGroup === 'function') updatePrivateInsuranceGroup();
        if (typeof updateCopayGroup === 'function') updateCopayGroup();
      });
    }

    // Using radio-based helpers defined later; no legacy single-input toggles needed.
  });
</script>
{% endif %}

<h2>Step 2: Medical Information</h2>

<form method="POST" action="/applications/{{ application.id }}/step/2">

  {% if errors and errors|length > 0 %}
    <div class="error-summary" style="background:#ffe6e6; color:#a94442; border:1px solid #a94442; padding:16px; margin-bottom:20px; border-radius:4px;">
      <strong>Please correct the following errors before continuing:</strong>
      <ul style="margin:10px 0 0 20px;">
        {% for field, message in errors %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  
  <div id="autosave-indicator"></div>

  <fieldset>
    <legend>Medical History</legend>
    
    <div class="form-row">
      <div class="form-group">
        <label for="medicalHistory.diagnosisYear" class="required">Year of Diagnosis</label>
           <input type="number" id="medicalHistory.diagnosisYear" name="medicalHistory[diagnosisYear]" 
             min="1951" max="{{ "now" | date("yyyy") }}" 
             value="{{ application.data.medicalHistory.diagnosisYear or '' }}" required>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            var diagnosisYear = document.getElementById('medicalHistory.diagnosisYear');
            var currentYear = new Date().getFullYear();
            diagnosisYear.addEventListener('input', function() {
              var val = parseInt(this.value);
              if (this.value && val < 1951) {
                this.setCustomValidity('Year must be after 1950.');
              } else if (this.value && val > currentYear) {
                this.setCustomValidity('Year cannot be in the future.');
              } else {
                this.setCustomValidity('');
              }
            });
          });
        </script>
        {% if errors['medicalHistory.diagnosisYear'] %}
          <div class="error">{{ errors['medicalHistory.diagnosisYear'] }}</div>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label class="required">Type of Lupus</label>
        <div class="segmented-control" id="lupusTypeControl">
          <label><input type="radio" name="medicalHistory[lupusType]" value="Discoid" {% if application.data.medicalHistory.lupusType == 'Discoid' %}checked{% endif %} required> Discoid</label>
          <label><input type="radio" name="medicalHistory[lupusType]" value="Systemic" {% if application.data.medicalHistory.lupusType == 'Systemic' %}checked{% endif %} required> Systemic</label>
          <label><input type="radio" name="medicalHistory[lupusType]" value="Both" {% if application.data.medicalHistory.lupusType == 'Both' %}checked{% endif %} required> Both</label>
        </div>
        {% if errors['medicalHistory.lupusType'] %}
          <div class="error">{{ errors['medicalHistory.lupusType'] }}</div>
        {% endif %}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="medicalHistory.physicianName" class="required">Physician Name</label>
           <input type="text" id="medicalHistory.physicianName" name="medicalHistory[physicianName]" 
             value="{{ application.data.medicalHistory.physicianName or '' }}" required>
        {% if errors['medicalHistory.physicianName'] %}
          <div class="error">{{ errors['medicalHistory.physicianName'] }}</div>
        {% endif %}
      </div>
      <div class="form-group">
        <label for="medicalHistory.physicianPhone" class="required">Physician Phone</label>
           <input type="tel" id="medicalHistory.physicianPhone" name="medicalHistory[physicianPhone]" 
             value="{{ application.data.medicalHistory.physicianPhone | phone }}" 
             placeholder="(999) 999-9999" 
             pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
             class="phone-input" required>
        {% if errors['medicalHistory.physicianPhone'] %}
          <div class="error">{{ errors['medicalHistory.physicianPhone'] }}</div>
        {% endif %}
      </div>
    </div>

  </fieldset>

  <fieldset>
    <legend>Medical Coverage</legend>
    
    <div class="form-group">
      <label class="required">Has Health Insurance</label>
      <div class="segmented-control" id="hasInsuranceControl">
        <label><input type="radio" id="medicalCoverage.hasInsurance-yes" name="medicalCoverage[hasInsurance]" value="true" {% if application.data.medicalCoverage.hasInsurance %}checked{% endif %}> Yes</label>
        <label><input type="radio" id="medicalCoverage.hasInsurance-no" name="medicalCoverage[hasInsurance]" value="false" {% if not application.data.medicalCoverage.hasInsurance %}checked{% endif %}> No</label>
      </div>
    </div>

    <div class="form-group">
      <label class="required">Coverage Type</label>
      <div class="segmented-control" id="coverageTypeControl">
        <label><input type="radio" id="medicalCoverage.coverageType-medicaid" name="medicalCoverage[coverageType]" value="Medicaid" {% if application.data.medicalCoverage.coverageType == 'Medicaid' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Medicaid</label>
        <label><input type="radio" id="medicalCoverage.coverageType-medicare" name="medicalCoverage[coverageType]" value="Medicare" {% if application.data.medicalCoverage.coverageType == 'Medicare' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Medicare</label>
        <label><input type="radio" id="medicalCoverage.coverageType-private" name="medicalCoverage[coverageType]" value="Private" {% if application.data.medicalCoverage.coverageType == 'Private' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Private</label>
      </div>
      {% if errors['medicalCoverage.coverageType'] %}
        <div class="error">{{ errors['medicalCoverage.coverageType'] }}</div>
      {% endif %}
    </div>

    <div class="form-group" id="privateInsuranceNameGroup" style="display: {{ 'block' if application.data.medicalCoverage.coverageType == 'Private' else 'none' }}">
      <label for="medicalCoverage.privateInsuranceName" class="required">Private Insurance Name</label>
        <input type="text" id="medicalCoverage.privateInsuranceName" name="medicalCoverage[privateInsuranceName]" 
          value="{{ application.data.medicalCoverage.privateInsuranceName or '' }}"
          {% if not application.data.medicalCoverage.hasInsurance or application.data.medicalCoverage.coverageType != 'Private' %}disabled{% endif %}
          {% if application.data.medicalCoverage.hasInsurance and application.data.medicalCoverage.coverageType == 'Private' %}required{% endif %}>
      {% if errors['medicalCoverage.privateInsuranceName'] %}
        <div class="error">{{ errors['medicalCoverage.privateInsuranceName'] }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label class="required">Prescription Drug Coverage</label>
      <div class="segmented-control" id="rxCoverageControl">
        <label><input type="radio" id="medicalCoverage.rxCoverage-none" name="medicalCoverage[rxCoverage]" value="None" {% if not application.data.medicalCoverage.rxCoverage or application.data.medicalCoverage.rxCoverage == 'None' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> None</label>
        <label><input type="radio" id="medicalCoverage.rxCoverage-yes" name="medicalCoverage[rxCoverage]" value="Yes" {% if application.data.medicalCoverage.rxCoverage == 'Yes' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Yes</label>
        <label><input type="radio" id="medicalCoverage.rxCoverage-no" name="medicalCoverage[rxCoverage]" value="No" {% if application.data.medicalCoverage.rxCoverage == 'No' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> No</label>
      </div>
      {% if errors['medicalCoverage.rxCoverage'] %}
        <div class="error">{{ errors['medicalCoverage.rxCoverage'] }}</div>
      {% endif %}
    </div>

    <div class="form-group" id="copayAmountGroup" style="display: {{ 'block' if application.data.medicalCoverage.rxCoverage == 'Yes' else 'none' }}">
      <label for="medicalCoverage.copayAmount" class="required">Copay Amount</label>
      <div class="currency-input-wrapper">
        <span class="currency-symbol">$</span>
        <input type="number" id="medicalCoverage.copayAmount" name="medicalCoverage[copayAmount]" 
          min="0" step="0.01" value="{{ application.data.medicalCoverage.copayAmount or '' }}"
          {% if not application.data.medicalCoverage.hasInsurance or application.data.medicalCoverage.rxCoverage != 'Yes' %}disabled{% endif %}
          {% if application.data.medicalCoverage.hasInsurance and application.data.medicalCoverage.rxCoverage == 'Yes' %}required{% endif %}>
      </div>
      {% if errors['medicalCoverage.copayAmount'] %}
        <div class="error">{{ errors['medicalCoverage.copayAmount'] }}</div>
      {% endif %}
    </div>
    <style>
      .currency-input-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        width: 100%;
      }
      .currency-symbol {
        position: absolute;
        left: 12px;
        pointer-events: none;
        font-weight: 500;
        color: #333;
      }
      .currency-input-wrapper input {
        padding-left: 28px;
      }
    </style>
  </fieldset>

  <div class="form-navigation">
    <a href="/applications/{{ application.id }}/step/1" class="btn-secondary">Back to Step 1</a>
    <button type="submit" id="step2-continue-btn">Continue to Step 3</button>
  </div>

<script>
  // Prevent both coverageType and rxCoverage from being 'None' if insurance is checked
  var step2Form = document.querySelector('form[action*="/step/2"]');
  if (step2Form) {
    step2Form.addEventListener('submit', function(e) {
      function getRadioValue(name) {
        var radios = document.getElementsByName(name);
        for (var i = 0; i < radios.length; i++) {
          if (radios[i].checked) return radios[i].value;
        }
        return null;
      }
      var hasInsurance = getRadioValue('medicalCoverage[hasInsurance]') === 'true';
      var coverageType = getRadioValue('medicalCoverage[coverageType]');
      var rxCoverage = getRadioValue('medicalCoverage[rxCoverage]');
      if (hasInsurance && coverageType === 'None' && rxCoverage === 'None') {
        alert('If you have health insurance, either Coverage Type or Prescription Drug Coverage must be selected. Both cannot be None.');
        e.preventDefault();
      }
    });
  }
</script>
</form>

<style>
  .segmented-control {
    display: flex;
    gap: 10px;
    margin: 5px 0 0 0;
  }
  .segmented-control label {
    background: #f4f4f4;
    border: 1px solid #bbb;
    border-radius: 4px;
    padding: 5px 14px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s, border 0.2s;
  }
  .segmented-control input[type="radio"] {
    display: none;
  }
  .segmented-control input[type="radio"]:checked + span,
  .segmented-control label:has(input[type="radio"]:checked) {
    background: #490075;
    color: #fff;
    border-color: #490075;
  }
</style>
<script>
  // Show/hide conditional fields for private insurance and copay
  // No employment controls on Step 2

  function updatePrivateInsuranceGroup() {
    var priv = document.getElementById('privateInsuranceNameGroup');
    var privRadio = document.getElementById('medicalCoverage.coverageType-private');
    priv.style.display = privRadio && privRadio.checked ? 'block' : 'none';
  }
  function updateCopayGroup() {
    var copay = document.getElementById('copayAmountGroup');
    var yesRadio = document.getElementById('medicalCoverage.rxCoverage-yes');
    copay.style.display = yesRadio && yesRadio.checked ? 'block' : 'none';
  }
  function updateCoverageTypeEnabled() {
    var hasInsuranceYes = document.getElementById('medicalCoverage.hasInsurance-yes');
    var coverageTypeRadios = document.querySelectorAll('input[name="medicalCoverage[coverageType]"]');
    if (hasInsuranceYes && hasInsuranceYes.checked) {
      coverageTypeRadios.forEach(function(radio) {
        radio.disabled = false;
        radio.required = true;
      });
    } else {
      coverageTypeRadios.forEach(function(radio) {
        radio.checked = false;
        radio.disabled = true;
        radio.required = false;
      });
    }
    updatePrivateInsuranceGroup();
  }
  document.querySelectorAll('input[name="medicalCoverage[coverageType]"]').forEach(function(radio) {
    radio.addEventListener('change', updatePrivateInsuranceGroup);
  });
  document.querySelectorAll('input[name="medicalCoverage[rxCoverage]"]').forEach(function(radio) {
    radio.addEventListener('change', updateCopayGroup);
  });
  document.querySelectorAll('input[name="medicalCoverage[hasInsurance]"]').forEach(function(radio) {
    radio.addEventListener('change', updateCoverageTypeEnabled);
  });
  // Initial state
  updateCoverageTypeEnabled();
  updateCopayGroup();
</script>
{% endblock %}
