{% extends "layouts/main.njk" %}

{% block content %}
<div class="progress-bar">
  <div class="progress-step">1. Applicant Info</div>
  <div class="progress-step active">2. Medical</div>
  <div class="progress-step">3. Income</div>
  <div class="progress-step">4. Residency</div>
  <div class="progress-step">5. Request</div>
  <div class="progress-step">6. Certification</div>
</div>


{% if isDevelopment %}
<div style="margin: 20px 0 10px 0;">
  <button type="button" id="populate-form-btn" style="background:#28a745; color:white; border:none; padding:10px 18px; border-radius:4px; font-size:15px;">Populate Form (Dev Only)</button>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('populate-form-btn');
    if (btn) {
      btn.addEventListener('click', function() {
        const data = {
          'medicalHistory[diagnosisYear]': '2010',
          'medicalHistory[lupusType]': 'Systemic',
          'medicalHistory[currentlyEmployed]': 'Yes',
          'medicalHistory[employmentStatus]': 'Full Time',
          'medicalHistory[spouseEmploymentStatus]': 'N/A',
          'medicalHistory[physicianName]': 'Dr. Smith',
          'medicalHistory[physicianPhone]': '(404) 555-1234',
          // Required radios
          'medicalCoverage[hasInsurance]': 'true',
          'medicalCoverage[coverageType]': 'Private',
          'medicalCoverage[rxCoverage]': 'Yes',
          // Dependent field when rxCoverage is Yes
          'medicalCoverage[privateInsuranceName]': 'Blue Cross',
          'medicalCoverage[copayAmount]': '25',
        };
        for (const [name, value] of Object.entries(data)) {
          // Special handling for radio groups
          const radios = document.querySelectorAll(`input[type="radio"][name="${name}"]`);
          if (radios.length > 0) {
            radios.forEach(radio => {
              radio.checked = (radio.value === value);
            });
            continue;
          }
          const el = document.querySelector(`[name="${name}"]`);
          if (el) {
            if (el.type === 'checkbox') {
              el.checked = true;
            } else {
              el.value = value;
            }
          }
        }
        // Refresh conditional UI after programmatic changes
        if (typeof updateEmploymentStatusRequired === 'function') updateEmploymentStatusRequired();
        if (typeof updateCoverageTypeEnabled === 'function') updateCoverageTypeEnabled();
        if (typeof updatePrivateInsuranceGroup === 'function') updatePrivateInsuranceGroup();
        if (typeof updateCopayGroup === 'function') updateCopayGroup();
      });
    }
  });
</script>
{% endif %}

<h2>Step 2: Medical Information</h2>

<form method="POST" action="/applications/{{ application.id }}/step/2">

  {% if errors and errors|length > 0 %}
    <div class="error-summary" style="background:#ffe6e6; color:#a94442; border:1px solid #a94442; padding:16px; margin-bottom:20px; border-radius:4px;">
      <strong>Please correct the following errors before continuing:</strong>
      <ul style="margin:10px 0 0 20px;">
        {% for field, message in errors %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  
  <div id="autosave-indicator"></div>

  <fieldset>
    <legend>Medical History</legend>
    
    <div class="form-row">
      <div class="form-group">
        <label for="medicalHistory.diagnosisYear" class="required">Year of Diagnosis</label>
           <input type="number" id="medicalHistory.diagnosisYear" name="medicalHistory[diagnosisYear]" 
             min="1951" max="{{ "now" | date("yyyy") }}" 
             value="{{ application.data.medicalHistory.diagnosisYear or '' }}" required>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            var diagnosisYear = document.getElementById('medicalHistory.diagnosisYear');
            var currentYear = new Date().getFullYear();
            diagnosisYear.addEventListener('input', function() {
              var val = parseInt(this.value);
              if (this.value && val < 1951) {
                this.setCustomValidity('Year must be after 1950.');
              } else if (this.value && val > currentYear) {
                this.setCustomValidity('Year cannot be in the future.');
              } else {
                this.setCustomValidity('');
              }
            });
          });
        </script>
        {% if errors['medicalHistory.diagnosisYear'] %}
          <div class="error">{{ errors['medicalHistory.diagnosisYear'] }}</div>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label class="required">Type of Lupus</label>
        <div class="segmented-control" id="lupusTypeControl">
          <label><input type="radio" name="medicalHistory[lupusType]" value="Discoid" {% if application.data.medicalHistory.lupusType == 'Discoid' %}checked{% endif %} required> Discoid</label>
          <label><input type="radio" name="medicalHistory[lupusType]" value="Systemic" {% if application.data.medicalHistory.lupusType == 'Systemic' %}checked{% endif %} required> Systemic</label>
          <label><input type="radio" name="medicalHistory[lupusType]" value="Both" {% if application.data.medicalHistory.lupusType == 'Both' %}checked{% endif %} required> Both</label>
        </div>
        {% if errors['medicalHistory.lupusType'] %}
          <div class="error">{{ errors['medicalHistory.lupusType'] }}</div>
        {% endif %}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="required">Currently Employed</label>
        <div class="segmented-control" id="currentlyEmployedControl">
          <label><input type="radio" name="medicalHistory[currentlyEmployed]" value="Yes" {% if application.data.medicalHistory.currentlyEmployed == 'Yes' %}checked{% endif %} required> Yes</label>
          <label><input type="radio" name="medicalHistory[currentlyEmployed]" value="No" {% if application.data.medicalHistory.currentlyEmployed == 'No' or not application.data.medicalHistory.currentlyEmployed %}checked{% endif %} required> No</label>
        </div>
        {% if errors['medicalHistory.currentlyEmployed'] %}
          <div class="error">{{ errors['medicalHistory.currentlyEmployed'] }}</div>
        {% endif %}
      </div>
      <div class="form-group">
        <label class="required">Receiving Unemployment Benefits</label>
        <div class="segmented-control" id="receivingUnemploymentControl">
          <label><input type="radio" name="medicalHistory[receivingUnemployment]" value="Yes" {% if application.data.medicalHistory.receivingUnemployment == 'Yes' %}checked{% endif %} required> Yes</label>
          <label><input type="radio" name="medicalHistory[receivingUnemployment]" value="No" {% if application.data.medicalHistory.receivingUnemployment == 'No' or not application.data.medicalHistory.receivingUnemployment %}checked{% endif %} required> No</label>
        </div>
        {% if errors['medicalHistory.receivingUnemployment'] %}
          <div class="error">{{ errors['medicalHistory.receivingUnemployment'] }}</div>
        {% endif %}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="required">Employment Status</label>
        <div class="segmented-control" id="employmentStatusControl">
          <label><input type="radio" name="medicalHistory[employmentStatus]" value="Full Time" {% if application.data.medicalHistory.employmentStatus == 'Full Time' %}checked{% endif %}> Full Time</label>
          <label><input type="radio" name="medicalHistory[employmentStatus]" value="Part Time" {% if application.data.medicalHistory.employmentStatus == 'Part Time' %}checked{% endif %}> Part Time</label>
          <label><input type="radio" name="medicalHistory[employmentStatus]" value="Unemployed" {% if application.data.medicalHistory.employmentStatus == 'Unemployed' %}checked{% endif %}> Unemployed</label>
          <label><input type="radio" name="medicalHistory[employmentStatus]" value="Self-Employed" {% if application.data.medicalHistory.employmentStatus == 'Self-Employed' %}checked{% endif %}> Self-Employed</label>
        </div>
        {% if errors['medicalHistory.employmentStatus'] %}
          <div class="error">{{ errors['medicalHistory.employmentStatus'] }}</div>
        {% endif %}
      </div>
      <div class="form-group">
        <label class="required">Spouse Employment Status</label>
        <div class="segmented-control" id="spouseEmploymentStatusControl">
          <label><input type="radio" name="medicalHistory[spouseEmploymentStatus]" value="Full Time" {% if application.data.medicalHistory.spouseEmploymentStatus == 'Full Time' %}checked{% endif %} required> Full Time</label>
          <label><input type="radio" name="medicalHistory[spouseEmploymentStatus]" value="Part Time" {% if application.data.medicalHistory.spouseEmploymentStatus == 'Part Time' %}checked{% endif %} required> Part Time</label>
          <label><input type="radio" name="medicalHistory[spouseEmploymentStatus]" value="Unemployed" {% if application.data.medicalHistory.spouseEmploymentStatus == 'Unemployed' %}checked{% endif %} required> Unemployed</label>
          <label><input type="radio" name="medicalHistory[spouseEmploymentStatus]" value="Self-Employed" {% if application.data.medicalHistory.spouseEmploymentStatus == 'Self-Employed' %}checked{% endif %} required> Self-Employed</label>
          <label><input type="radio" name="medicalHistory[spouseEmploymentStatus]" value="N/A" {% if application.data.medicalHistory.spouseEmploymentStatus == 'N/A' %}checked{% endif %} required> N/A</label>
        </div>
        {% if errors['medicalHistory.spouseEmploymentStatus'] %}
          <div class="error">{{ errors['medicalHistory.spouseEmploymentStatus'] }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="medicalHistory.physicianName" class="required">Physician Name</label>
           <input type="text" id="medicalHistory.physicianName" name="medicalHistory[physicianName]" 
             value="{{ application.data.medicalHistory.physicianName or '' }}" required>
        {% if errors['medicalHistory.physicianName'] %}
          <div class="error">{{ errors['medicalHistory.physicianName'] }}</div>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label for="medicalHistory.physicianPhone" class="required">Physician Phone</label>
           <input type="tel" id="medicalHistory.physicianPhone" name="medicalHistory[physicianPhone]" 
             value="{{ application.data.medicalHistory.physicianPhone | phone }}" 
             placeholder="(999) 999-9999" 
             pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}" 
             class="phone-input" required>
        {% if errors['medicalHistory.physicianPhone'] %}
          <div class="error">{{ errors['medicalHistory.physicianPhone'] }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="required">Have you applied for disability?</label>
        <div class="segmented-control" id="appliedDisabilityControl">
          <label><input type="radio" name="medicalHistory[appliedForDisability]" value="Yes" {% if application.data.medicalHistory.appliedForDisability == 'Yes' %}checked{% endif %} required> Yes</label>
          <label><input type="radio" name="medicalHistory[appliedForDisability]" value="No" {% if application.data.medicalHistory.appliedForDisability == 'No' or not application.data.medicalHistory.appliedForDisability %}checked{% endif %} required> No</label>
        </div>
        {% if errors['medicalHistory.appliedForDisability'] %}
          <div class="error">{{ errors['medicalHistory.appliedForDisability'] }}</div>
        {% endif %}
      </div>
      <div class="form-group">
        <label class="required">Do you receive benefits?</label>
        <div class="segmented-control" id="receiveBenefitsControl">
          <label><input type="radio" name="medicalHistory[receiveBenefits]" value="SSDI" {% if application.data.medicalHistory.receiveBenefits == 'SSDI' %}checked{% endif %} required> SSDI</label>
          <label><input type="radio" name="medicalHistory[receiveBenefits]" value="SSI" {% if application.data.medicalHistory.receiveBenefits == 'SSI' %}checked{% endif %} required> SSI</label>
          <label><input type="radio" name="medicalHistory[receiveBenefits]" value="No Benefits" {% if application.data.medicalHistory.receiveBenefits == 'No Benefits' or not application.data.medicalHistory.receiveBenefits %}checked{% endif %} required> No Benefits</label>
        </div>
        {% if errors['medicalHistory.receiveBenefits'] %}
          <div class="error">{{ errors['medicalHistory.receiveBenefits'] }}</div>
        {% endif %}
        <div id="monthlyAmountGroup" style="margin-top:10px; display: {% if application.data.medicalHistory.receiveBenefits == 'SSDI' or application.data.medicalHistory.receiveBenefits == 'SSI' %}block{% else %}none{% endif %};">
          <label for="medicalHistory.monthlyAmount">Monthly Amount (if receiving SSDI/SSI)</label>
          <div style="position:relative;">
            <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#666; font-size:15px;">$</span>
            <input type="number" id="medicalHistory.monthlyAmount" name="medicalHistory[monthlyAmount]" min="0" step="0.01" value="{{ application.data.medicalHistory.monthlyAmount or '' }}" style="padding-left:22px; width:90%;">
          </div>
          {% if errors['medicalHistory.monthlyAmount'] %}
            <div class="error">{{ errors['medicalHistory.monthlyAmount'] }}</div>
          {% endif %}
        </div>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            var radios = document.querySelectorAll('input[name="medicalHistory[receiveBenefits]"]');
            var group = document.getElementById('monthlyAmountGroup');
            radios.forEach(function(radio) {
              radio.addEventListener('change', function() {
                if (this.value === 'SSDI' || this.value === 'SSI') {
                  group.style.display = 'block';
                } else {
                  group.style.display = 'none';
                }
              });
            });
          });
        </script>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Medical Coverage</legend>
    
    <div class="form-group">
      <label class="required">Has Health Insurance</label>
      <div class="segmented-control" id="hasInsuranceControl">
        <label><input type="radio" id="medicalCoverage.hasInsurance-yes" name="medicalCoverage[hasInsurance]" value="true" {% if application.data.medicalCoverage.hasInsurance %}checked{% endif %}> Yes</label>
        <label><input type="radio" id="medicalCoverage.hasInsurance-no" name="medicalCoverage[hasInsurance]" value="false" {% if not application.data.medicalCoverage.hasInsurance %}checked{% endif %}> No</label>
      </div>
    </div>

    <div class="form-group">
      <label class="required">Coverage Type</label>
      <div class="segmented-control" id="coverageTypeControl">
        <label><input type="radio" id="medicalCoverage.coverageType-medicaid" name="medicalCoverage[coverageType]" value="Medicaid" {% if application.data.medicalCoverage.coverageType == 'Medicaid' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Medicaid</label>
        <label><input type="radio" id="medicalCoverage.coverageType-medicare" name="medicalCoverage[coverageType]" value="Medicare" {% if application.data.medicalCoverage.coverageType == 'Medicare' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Medicare</label>
        <label><input type="radio" id="medicalCoverage.coverageType-private" name="medicalCoverage[coverageType]" value="Private" {% if application.data.medicalCoverage.coverageType == 'Private' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Private</label>
      </div>
      {% if errors['medicalCoverage.coverageType'] %}
        <div class="error">{{ errors['medicalCoverage.coverageType'] }}</div>
      {% endif %}
    </div>

    <div class="form-group" id="privateInsuranceNameGroup" style="display: {{ 'block' if application.data.medicalCoverage.coverageType == 'Private' else 'none' }}">
      <label for="medicalCoverage.privateInsuranceName" class="required">Private Insurance Name</label>
        <input type="text" id="medicalCoverage.privateInsuranceName" name="medicalCoverage[privateInsuranceName]" 
          value="{{ application.data.medicalCoverage.privateInsuranceName or '' }}"
          {% if not application.data.medicalCoverage.hasInsurance or application.data.medicalCoverage.coverageType != 'Private' %}disabled{% endif %}
          {% if application.data.medicalCoverage.hasInsurance and application.data.medicalCoverage.coverageType == 'Private' %}required{% endif %}>
      {% if errors['medicalCoverage.privateInsuranceName'] %}
        <div class="error">{{ errors['medicalCoverage.privateInsuranceName'] }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label class="required">Prescription Drug Coverage</label>
      <div class="segmented-control" id="rxCoverageControl">
        <label><input type="radio" id="medicalCoverage.rxCoverage-none" name="medicalCoverage[rxCoverage]" value="None" {% if not application.data.medicalCoverage.rxCoverage or application.data.medicalCoverage.rxCoverage == 'None' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> None</label>
        <label><input type="radio" id="medicalCoverage.rxCoverage-yes" name="medicalCoverage[rxCoverage]" value="Yes" {% if application.data.medicalCoverage.rxCoverage == 'Yes' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> Yes</label>
        <label><input type="radio" id="medicalCoverage.rxCoverage-no" name="medicalCoverage[rxCoverage]" value="No" {% if application.data.medicalCoverage.rxCoverage == 'No' %}checked{% endif %} {% if not application.data.medicalCoverage.hasInsurance %}disabled{% endif %}> No</label>
      </div>
      {% if errors['medicalCoverage.rxCoverage'] %}
        <div class="error">{{ errors['medicalCoverage.rxCoverage'] }}</div>
      {% endif %}
    </div>

    <div class="form-group" id="copayAmountGroup" style="display: {{ 'block' if application.data.medicalCoverage.rxCoverage == 'Yes' else 'none' }}">
      <label for="medicalCoverage.copayAmount" class="required">Copay Amount</label>
        <div style="position:relative; display:flex; align-items:center; gap:8px;">
          <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#666; font-size:15px;">$</span>
          <input type="number" id="medicalCoverage.copayAmount" name="medicalCoverage[copayAmount]" 
            min="0" step="0.01" value="{{ application.data.medicalCoverage.copayAmount or '' }}" style="padding-left:22px; width:90%;"
            {% if not application.data.medicalCoverage.hasInsurance or application.data.medicalCoverage.rxCoverage != 'Yes' %}disabled{% endif %}
            {% if application.data.medicalCoverage.hasInsurance and application.data.medicalCoverage.rxCoverage == 'Yes' %}required{% endif %}>
        </div>
      {% if errors['medicalCoverage.copayAmount'] %}
        <div class="error">{{ errors['medicalCoverage.copayAmount'] }}</div>
      {% endif %}
    </div>
  </fieldset>

  <div class="form-navigation">
    <a href="/applications/{{ application.id }}/step/1" class="btn-secondary">Back to Step 1</a>
    <button type="submit" id="step2-continue-btn">Continue to Step 3</button>
  </div>

<script>
  // Prevent both coverageType and rxCoverage from being 'None' if insurance is checked
  var step2Form = document.querySelector('form[action*="/step/2"]');
  if (step2Form) {
    step2Form.addEventListener('submit', function(e) {
      function getRadioValue(name) {
        var radios = document.getElementsByName(name);
        for (var i = 0; i < radios.length; i++) {
          if (radios[i].checked) return radios[i].value;
        }
        return null;
      }
      var hasInsurance = getRadioValue('medicalCoverage[hasInsurance]') === 'true';
      var coverageType = getRadioValue('medicalCoverage[coverageType]');
      var rxCoverage = getRadioValue('medicalCoverage[rxCoverage]');
      if (hasInsurance && coverageType === 'None' && rxCoverage === 'None') {
        alert('If you have health insurance, either Coverage Type or Prescription Drug Coverage must be selected. Both cannot be None.');
        e.preventDefault();
      }
    });
  }
</script>
</form>

<style>
  .segmented-control {
    display: flex;
    gap: 10px;
    margin: 5px 0 0 0;
  }
  .segmented-control label {
    background: #f4f4f4;
    border: 1px solid #bbb;
    border-radius: 4px;
    padding: 5px 14px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s, border 0.2s;
  }
  .segmented-control input[type="radio"] {
    display: none;
  }
  .segmented-control input[type="radio"]:checked + span,
  .segmented-control label:has(input[type="radio"]:checked) {
    background: #490075;
    color: #fff;
    border-color: #490075;
  }
</style>
<script>
  // Show/hide conditional fields for private insurance and copay
  function updateEmploymentStatusRequired() {
    var employedYes = document.querySelector('input[name="medicalHistory[currentlyEmployed]"][value="Yes"]');
    var statusRadios = document.querySelectorAll('input[name="medicalHistory[employmentStatus]"]');
    var require = employedYes && employedYes.checked;
    statusRadios.forEach(function(radio){
      radio.required = require;
      if (!require) {
        radio.checked = false;
      }
    });
  }

  function updatePrivateInsuranceGroup() {
    var priv = document.getElementById('privateInsuranceNameGroup');
    var privRadio = document.getElementById('medicalCoverage.coverageType-private');
    priv.style.display = privRadio && privRadio.checked ? 'block' : 'none';
  }
  function updateCopayGroup() {
    var copay = document.getElementById('copayAmountGroup');
    var yesRadio = document.getElementById('medicalCoverage.rxCoverage-yes');
    copay.style.display = yesRadio && yesRadio.checked ? 'block' : 'none';
  }
  function updateCoverageTypeEnabled() {
    var hasInsuranceYes = document.getElementById('medicalCoverage.hasInsurance-yes');
    var coverageTypeRadios = document.querySelectorAll('input[name="medicalCoverage[coverageType]"]');
    if (hasInsuranceYes && hasInsuranceYes.checked) {
      coverageTypeRadios.forEach(function(radio) {
        radio.disabled = false;
        radio.required = true;
      });
    } else {
      coverageTypeRadios.forEach(function(radio) {
        radio.checked = false;
        radio.disabled = true;
        radio.required = false;
      });
    }
    updatePrivateInsuranceGroup();
  }
  document.querySelectorAll('input[name="medicalCoverage[coverageType]"]').forEach(function(radio) {
    radio.addEventListener('change', updatePrivateInsuranceGroup);
  });
  document.querySelectorAll('input[name="medicalCoverage[rxCoverage]"]').forEach(function(radio) {
    radio.addEventListener('change', updateCopayGroup);
  });
  document.querySelectorAll('input[name="medicalCoverage[hasInsurance]"]').forEach(function(radio) {
    radio.addEventListener('change', updateCoverageTypeEnabled);
  });
  document.querySelectorAll('input[name="medicalHistory[currentlyEmployed]"]').forEach(function(radio) {
    radio.addEventListener('change', updateEmploymentStatusRequired);
  });
  // Initial state
  updateEmploymentStatusRequired();
  updateCoverageTypeEnabled();
  updateCopayGroup();
</script>
{% endblock %}
